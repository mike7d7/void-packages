# Template file for 'nvidia-open-dkms'
pkgname=nvidia-open-dkms
version=560.31.02
revision=1
archs="x86_64"
depends="dkms nvidia"
short_desc="NVIDIA Linux open GPU kernel module source"
maintainer="mike7d7 <mike7d7@proton.me>"
license="GPL-2.0-only, MIT"
homepage="https://github.com/NVIDIA/open-gpu-kernel-modules"
changelog="https://github.com/NVIDIA/open-gpu-kernel-modules/blob/main/CHANGELOG.md"
distfiles="https://github.com/NVIDIA/open-gpu-kernel-modules/archive/refs/tags/${version}.tar.gz"
checksum=f432713459cbc3d61eb353b76c71bb215ce5645c024024784731545510086f6d
replaces="nvidia-dkms>=0"
dkms_modules="nvidia-open-dkms ${version}"
triggers="dkms initramfs-regenerate"


do_install() {
	vmkdir usr/src/nvidia-open-dkms-${version}
	vcopy "*" usr/src/nvidia-open-dkms-${version}
	cp ${FILESDIR}/dkms.conf ${DESTDIR}/usr/src/nvidia-open-dkms-${version}/dkms.conf
	vsed -e "s/__VERSION_STRING/${version}/" -i ${DESTDIR}/usr/src/nvidia-open-dkms-${version}/dkms.conf

	vmkdir usr/lib/modprobe.d
	echo "blacklist nouveau" > ${DESTDIR}/usr/lib/modprobe.d/nvidia.conf
	echo "options nvidia NVreg_OpenRmEnableUnsupportedGpus=1" >> ${DESTDIR}/usr/lib/modprobe.d/nvidia.conf
	chmod 644 ${DESTDIR}/usr/lib/modprobe.d/nvidia.conf

	vdoc README.md
	vlicense COPYING

	pkg_install() {
		vmove usr/src
		vmove usr/lib/modprobe.d
	}
}
